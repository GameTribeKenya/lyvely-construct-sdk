!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).LyvelySDK={})}(this,function(t){"use strict";var e,n=function(t,e){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},n(t,e)},i=function(){return i=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++)for(var r in e=arguments[n])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t},i.apply(this,arguments)};function r(t,e,n,i){return new(n||(n=Promise))(function(r,s){function o(t){try{c(i.next(t))}catch(t){s(t)}}function a(t){try{c(i.throw(t))}catch(t){s(t)}}function c(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n(function(t){t(e)})).then(o,a)}c((i=i.apply(t,e||[])).next())})}function s(t,e){var n,i,r,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},o=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return o.next=a(0),o.throw=a(1),o.return=a(2),"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(a){return function(c){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;o&&(o=0,a[0]&&(s=0)),s;)try{if(n=1,i&&(r=2&a[0]?i.return:a[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,a[1])).done)return r;switch(i=0,r&&(a=[2&a[0],r.value]),a[0]){case 0:case 1:r=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,i=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!((r=(r=s.trys).length>0&&r[r.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!r||a[1]>r[0]&&a[1]<r[3])){s.label=a[1];break}if(6===a[0]&&s.label<r[1]){s.label=r[1],r=a;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(a);break}r[2]&&s.ops.pop(),s.trys.pop();continue}a=e.call(t,s)}catch(t){a=[6,t],i=0}finally{n=r=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,c])}}}"function"==typeof SuppressedError&&SuppressedError,t.SDKErrorType=void 0,(e=t.SDKErrorType||(t.SDKErrorType={})).NETWORK_ERROR="NETWORK_ERROR",e.AUTH_ERROR="AUTH_ERROR",e.SESSION_EXPIRED="SESSION_EXPIRED",e.RATE_LIMITED="RATE_LIMITED",e.INVALID_SCORE="INVALID_SCORE",e.VALIDATION_ERROR="VALIDATION_ERROR",e.UNKNOWN_ERROR="UNKNOWN_ERROR";var o=function(t){function e(n,i,r,s){var o=t.call(this,i)||this;return o.name="SDKError",o.type=n,o.statusCode=r,o.details=s,Error.captureStackTrace&&Error.captureStackTrace(o,e),o}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function i(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}(e,t),e}(Error),a=function(){function e(t,e,n){void 0===n&&(n=!1),this.token=null,this.baseUrl=t.replace(/\/$/,""),this.apiKey=e,this.debug=n}return e.prototype.setToken=function(t){this.token=t},e.prototype.clearToken=function(){this.token=null},e.prototype.request=function(e,n){return r(this,arguments,void 0,function(e,n,r){var a,c,u,h,l,p,d,f;return void 0===r&&(r=3),s(this,function(y){switch(y.label){case 0:a="".concat(this.baseUrl).concat(e),c=i({"Content-Type":"application/json","X-API-Key":this.apiKey},n.headers),this.token&&(c.Authorization="Bearer ".concat(this.token)),u={method:n.method,headers:c,body:n.body?JSON.stringify(n.body):void 0},this.debug&&console.log("[Lyvely SDK] ".concat(n.method," ").concat(a),n.body),h=null,l=function(e){var c,l,d,f,y,v,b,g,m;return s(this,function(s){switch(s.label){case 0:return s.trys.push([0,5,,7]),c=new AbortController,l=n.timeout||3e4,d=setTimeout(function(){return c.abort()},l),[4,fetch(a,i(i({},u),{signal:c.signal}))];case 1:return f=s.sent(),clearTimeout(d),f.ok?[3,3]:[4,f.json().catch(function(){return{}})];case 2:switch(y=s.sent(),p.debug&&console.error("[Lyvely SDK] Error ".concat(f.status,":"),y),v=void 0,f.status){case 401:case 403:v=t.SDKErrorType.AUTH_ERROR;break;case 404:v=t.SDKErrorType.SESSION_EXPIRED;break;case 429:v=t.SDKErrorType.RATE_LIMITED;break;case 400:v=t.SDKErrorType.VALIDATION_ERROR;break;default:v=t.SDKErrorType.NETWORK_ERROR}throw new o(v,y.message||"HTTP ".concat(f.status,": ").concat(f.statusText),f.status,y);case 3:return[4,f.json()];case 4:return b=s.sent(),p.debug&&console.log("[Lyvely SDK] Response:",b),[2,{value:b}];case 5:if(g=s.sent(),h=g,g instanceof o&&(g.type===t.SDKErrorType.AUTH_ERROR||g.type===t.SDKErrorType.VALIDATION_ERROR||g.type===t.SDKErrorType.SESSION_EXPIRED))throw g;return e>=r?[2,"break"]:(m=1e3*Math.pow(2,e),p.debug&&console.warn("[Lyvely SDK] Retrying in ".concat(m,"ms (attempt ").concat(e+1,"/").concat(r,")")),[4,p.sleep(m)]);case 6:return s.sent(),[3,7];case 7:return[2]}})},p=this,d=0,y.label=1;case 1:return d<=r?[5,l(d)]:[3,4];case 2:if("object"==typeof(f=y.sent()))return[2,f.value];if("break"===f)return[3,4];y.label=3;case 3:return d++,[3,1];case 4:if(h instanceof o)throw h;throw new o(t.SDKErrorType.NETWORK_ERROR,(null==h?void 0:h.message)||"Network request failed",void 0,h)}})})},e.prototype.get=function(t,e){return r(this,void 0,void 0,function(){return s(this,function(n){return[2,this.request(t,i({method:"GET"},e))]})})},e.prototype.post=function(t,e,n){return r(this,void 0,void 0,function(){return s(this,function(r){return[2,this.request(t,i({method:"POST",body:e},n))]})})},e.prototype.put=function(t,e,n){return r(this,void 0,void 0,function(){return s(this,function(r){return[2,this.request(t,i({method:"PUT",body:e},n))]})})},e.prototype.sleep=function(t){return new Promise(function(e){return setTimeout(e,t)})},e}(),c=function(){function t(){this.listeners=new Map}return t.prototype.on=function(t,e){this.listeners.has(t)||this.listeners.set(t,new Set),this.listeners.get(t).add(e)},t.prototype.off=function(t,e){var n=this.listeners.get(t);n&&n.delete(e)},t.prototype.emit=function(t,e){var n=this.listeners.get(t);n&&n.forEach(function(n){try{n(e)}catch(e){console.error("[Lyvely SDK] Error in ".concat(t," event handler:"),e)}})},t.prototype.removeAllListeners=function(t){t?this.listeners.delete(t):this.listeners.clear()},t}(),u=function(){function e(t,e,n,i){var r=this;this.session=null,this.heartbeatTimer=null,this.httpClient=t,this.eventEmitter=e,this.heartbeatInterval=n,this.debug=i,"undefined"!=typeof document&&document.addEventListener("visibilitychange",function(){document.hidden?r.pauseHeartbeat():r.resumeHeartbeat()})}return e.prototype.startSession=function(e,n){return r(this,void 0,void 0,function(){var r,a,c;return s(this,function(s){switch(s.label){case 0:return s.trys.push([0,4,,5]),this.session?(this.debug&&console.warn("[Lyvely SDK] Session already active, ending previous session"),[4,this.endSession()]):[3,2];case 1:s.sent(),s.label=2;case 2:return[4,this.httpClient.post("/api/v1/sessions",{userId:e,metadata:i(i({},n),{userAgent:"undefined"!=typeof navigator?navigator.userAgent:void 0,timestamp:(new Date).toISOString()})})];case 3:return r=s.sent(),this.session=r,this.httpClient.setToken(r.token),this.startHeartbeat(),this.eventEmitter.emit("sessionStart",{sessionId:r.sessionId,userId:r.userId}),this.debug&&console.log("[Lyvely SDK] Session started:",r.sessionId),[2,r];case 4:if((a=s.sent())instanceof o)throw this.eventEmitter.emit("error",a),a;throw c=new o(t.SDKErrorType.UNKNOWN_ERROR,"Failed to start session",void 0,a),this.eventEmitter.emit("error",c),c;case 5:return[2]}})})},e.prototype.endSession=function(e,n){return r(this,void 0,void 0,function(){var r,a,c;return s(this,function(s){switch(s.label){case 0:if(!this.session)return this.debug&&console.warn("[Lyvely SDK] No active session to end"),[2,null];s.label=1;case 1:return s.trys.push([1,3,,4]),this.stopHeartbeat(),[4,this.httpClient.post("/api/v1/sessions/".concat(this.session.sessionId,"/end"),i({finalScore:e,completed:!0},n))];case 2:return r=s.sent(),this.eventEmitter.emit("sessionEnd",r),this.debug&&console.log("[Lyvely SDK] Session ended:",this.session.sessionId),this.cleanup(),[2,r];case 3:if(a=s.sent(),this.cleanup(),a instanceof o)throw this.eventEmitter.emit("error",a),a;throw c=new o(t.SDKErrorType.UNKNOWN_ERROR,"Failed to end session",void 0,a),this.eventEmitter.emit("error",c),c;case 4:return[2]}})})},e.prototype.getSession=function(){return this.session},e.prototype.hasActiveSession=function(){return null!==this.session},e.prototype.startHeartbeat=function(){var t=this;this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.heartbeatTimer=window.setInterval(function(){t.sendHeartbeat()},this.heartbeatInterval),this.debug&&console.log("[Lyvely SDK] Heartbeat started (".concat(this.heartbeatInterval,"ms interval)"))},e.prototype.stopHeartbeat=function(){this.heartbeatTimer&&(clearInterval(this.heartbeatTimer),this.heartbeatTimer=null,this.debug&&console.log("[Lyvely SDK] Heartbeat stopped"))},e.prototype.pauseHeartbeat=function(){this.heartbeatTimer&&this.debug&&console.log("[Lyvely SDK] Heartbeat paused (tab hidden)")},e.prototype.resumeHeartbeat=function(){this.session&&this.debug&&(console.log("[Lyvely SDK] Heartbeat resumed (tab visible)"),this.sendHeartbeat())},e.prototype.sendHeartbeat=function(){return r(this,void 0,void 0,function(){var e;return s(this,function(n){switch(n.label){case 0:if(!this.session)return this.stopHeartbeat(),[2];n.label=1;case 1:return n.trys.push([1,3,,4]),[4,this.httpClient.post("/api/v1/sessions/".concat(this.session.sessionId,"/heartbeat"),{timestamp:(new Date).toISOString()})];case 2:return n.sent(),this.eventEmitter.emit("heartbeat",{sessionId:this.session.sessionId}),this.debug&&console.log("[Lyvely SDK] Heartbeat sent"),[3,4];case 3:return(e=n.sent())instanceof o&&e.type===t.SDKErrorType.SESSION_EXPIRED?(this.debug&&console.error("[Lyvely SDK] Session expired"),this.stopHeartbeat(),this.eventEmitter.emit("sessionExpired",{sessionId:this.session.sessionId}),this.cleanup()):this.debug&&console.error("[Lyvely SDK] Heartbeat failed:",e),[3,4];case 4:return[2]}})})},e.prototype.cleanup=function(){this.session=null,this.httpClient.clearToken()},e.prototype.destroy=function(){this.stopHeartbeat(),this.cleanup()},e}(),LyvelySDK=function(){function LyvelySDK(t){if(this.isInitialized=!1,this.initPromise=null,this.config={gameId:t.gameId,apiKey:t.apiKey,apiBaseUrl:t.apiBaseUrl||"https://api.lyvely.com",environment:t.environment||"production",debug:t.debug||!1,heartbeatInterval:t.heartbeatInterval||6e4,sessionTimeout:t.sessionTimeout||3e5},!this.config.gameId)throw new Error("Lyvely SDK: gameId is required");if(!this.config.apiKey)throw new Error("Lyvely SDK: apiKey is required");this.config.apiKey.startsWith("pk_")||console.warn("Lyvely SDK: apiKey should be a publishable key (pk_live_* or pk_test_*)"),this.eventEmitter=new c,this.httpClient=new a(this.config.apiBaseUrl,this.config.apiKey,this.config.debug),this.sessionManager=new u(this.httpClient,this.eventEmitter,this.config.heartbeatInterval,this.config.debug),this.config.debug&&console.log("[Lyvely SDK] Initialized with config:",{gameId:this.config.gameId,environment:this.config.environment,apiBaseUrl:this.config.apiBaseUrl})}return LyvelySDK.prototype.init=function(){return r(this,void 0,void 0,function(){return s(this,function(t){return this.isInitialized?[2]:(this.initPromise||(this.initPromise=this._init()),[2,this.initPromise])})})},LyvelySDK.prototype._init=function(){return r(this,void 0,void 0,function(){var e,n;return s(this,function(i){switch(i.label){case 0:return i.trys.push([0,2,,3]),[4,this.httpClient.get("/api/v1/games/".concat(this.config.gameId))];case 1:return i.sent(),this.isInitialized=!0,this.eventEmitter.emit("ready"),this.config.debug&&console.log("[Lyvely SDK] Ready"),[3,3];case 2:throw e=i.sent(),n=e instanceof o?e:new o(t.SDKErrorType.UNKNOWN_ERROR,"Failed to initialize SDK",void 0,e),this.eventEmitter.emit("error",n),n;case 3:return[2]}})})},LyvelySDK.prototype.ready=function(){return r(this,void 0,void 0,function(){return s(this,function(t){return[2,this.init()]})})},LyvelySDK.prototype.startSession=function(t,e){return r(this,void 0,void 0,function(){var n;return s(this,function(r){switch(r.label){case 0:return[4,this.ensureInitialized()];case 1:return r.sent(),n=t||this.getOrCreateAnonymousUserId(),[2,this.sessionManager.startSession(n,i(i({},e),{gameId:this.config.gameId}))]}})})},LyvelySDK.prototype.submitScore=function(e,n){return r(this,void 0,void 0,function(){var r,a,c,u;return s(this,function(s){switch(s.label){case 0:return[4,this.ensureInitialized()];case 1:if(s.sent(),!(r=this.sessionManager.getSession()))throw new o(t.SDKErrorType.VALIDATION_ERROR,"No active session. Call startSession() first.");s.label=2;case 2:return s.trys.push([2,4,,5]),[4,this.httpClient.post("/api/v1/sessions/".concat(r.sessionId,"/score"),{score:e,metadata:i(i({},n),{timestamp:(new Date).toISOString()})})];case 3:return a=s.sent(),this.eventEmitter.emit("scoreSubmitted",{score:e,rank:a.rank,isNewHighScore:a.isNewHighScore}),this.config.debug&&console.log("[Lyvely SDK] Score submitted:",e,"Rank:",a.rank),[2,a];case 4:if((c=s.sent())instanceof o)throw this.eventEmitter.emit("error",c),c;throw u=new o(t.SDKErrorType.UNKNOWN_ERROR,"Failed to submit score",void 0,c),this.eventEmitter.emit("error",u),u;case 5:return[2]}})})},LyvelySDK.prototype.endSession=function(t,e){return r(this,void 0,void 0,function(){return s(this,function(n){switch(n.label){case 0:return[4,this.ensureInitialized()];case 1:return n.sent(),[2,this.sessionManager.endSession(t,e)]}})})},LyvelySDK.prototype.getLeaderboard=function(e){return r(this,void 0,void 0,function(){var n,i,r,a,c,u;return s(this,function(s){switch(s.label){case 0:return[4,this.ensureInitialized()];case 1:s.sent(),n=new URLSearchParams,(null==e?void 0:e.period)&&n.append("period",e.period),(null==e?void 0:e.limit)&&n.append("limit",e.limit.toString()),(null==e?void 0:e.offset)&&n.append("offset",e.offset.toString()),i=n.toString(),r="/api/v1/leaderboards/".concat(this.config.gameId).concat(i?"?"+i:""),s.label=2;case 2:return s.trys.push([2,4,,5]),[4,this.httpClient.get(r)];case 3:return a=s.sent(),this.config.debug&&console.log("[Lyvely SDK] Leaderboard fetched:",a.entries.length,"entries"),[2,a];case 4:if((c=s.sent())instanceof o)throw this.eventEmitter.emit("error",c),c;throw u=new o(t.SDKErrorType.UNKNOWN_ERROR,"Failed to fetch leaderboard",void 0,c),this.eventEmitter.emit("error",u),u;case 5:return[2]}})})},LyvelySDK.prototype.getSession=function(){return this.sessionManager.getSession()},LyvelySDK.prototype.hasActiveSession=function(){return this.sessionManager.hasActiveSession()},LyvelySDK.prototype.on=function(t,e){this.eventEmitter.on(t,e)},LyvelySDK.prototype.off=function(t,e){this.eventEmitter.off(t,e)},LyvelySDK.prototype.getVersion=function(){return"0.1.0"},LyvelySDK.prototype.getConfig=function(){return{gameId:this.config.gameId,apiBaseUrl:this.config.apiBaseUrl,environment:this.config.environment,debug:this.config.debug}},LyvelySDK.prototype.destroy=function(){this.sessionManager.destroy(),this.eventEmitter.removeAllListeners(),this.isInitialized=!1,this.initPromise=null,this.config.debug&&console.log("[Lyvely SDK] Destroyed")},LyvelySDK.prototype.ensureInitialized=function(){return r(this,void 0,void 0,function(){return s(this,function(t){switch(t.label){case 0:return this.isInitialized?[3,2]:[4,this.init()];case 1:t.sent(),t.label=2;case 2:return[2]}})})},LyvelySDK.prototype.getOrCreateAnonymousUserId=function(){var t="lyvely_user_".concat(this.config.gameId);if("undefined"!=typeof localStorage){var e=localStorage.getItem(t);return e||(e="anon_".concat(Date.now(),"_").concat(Math.random().toString(36).substring(2,11)),localStorage.setItem(t,e)),e}return"anon_".concat(Date.now(),"_").concat(Math.random().toString(36).substring(2,11))},LyvelySDK}();t.LyvelySDK=LyvelySDK,t.SDKError=o,t.default=LyvelySDK,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=lyvely-game-sdk.js.map
